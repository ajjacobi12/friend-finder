<!DOCTYPE html>
<html>
<head>
    <title>Socket Master Dashboard</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 30px; background-color: #f4f4f9; display: flex; flex-direction: column; align-items: center; }
        .container { width: 100%; max-width: 550px; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .status { padding: 10px; margin-bottom: 20px; border-radius: 6px; text-align: center; font-weight: bold; }
        .online { background: #d4edda; color: #155724; }
        .offline { background: #f8d7da; color: #721c24; }
        .card { border-top: 2px solid #eee; padding-top: 15px; margin-top: 15px; }
        
        input { padding: 10px; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 10px; }
        .setup-input { width: 70%; }
        
        button { padding: 8px 12px; cursor: pointer; border: none; border-radius: 4px; font-weight: bold; font-size: 12px; transition: 0.2s; }
        .btn-create { background: #28a745; color: white; }
        .btn-join { background: #007bff; color: white; }
        .btn-send { background: #007bff; color: white; padding: 10px 20px; }
        
        .btn-kick { background: #dc3545; color: white; margin-left: 5px; }
        .btn-transfer { background: #f39c12; color: white; margin-left: 5px; }
        .btn-dm { background: #6f42c1; color: white; margin-left: 5px; }

        /* --- New Styling for Editing/Deleting --- */
        .msg-actions { display: none; margin-top: 5px; border-top: 1px solid rgba(255,255,255,0.2); padding-top: 4px; gap: 8px; }
        .my-msg:hover .msg-actions { display: flex; }
        .btn-msg-action { background: none; border: 1px solid white; color: white; padding: 2px 6px; font-size: 9px; opacity: 0.8; }
        .btn-msg-action:hover { opacity: 1; background: rgba(255,255,255,0.1); }
        .edited-indicator { font-size: 10px; font-style: italic; opacity: 0.7; margin-left: 5px; }
        .deleted-msg { font-style: italic; opacity: 0.5; }
        #editModeBar { display: none; background: #fff3cd; padding: 8px; border-radius: 4px; margin-bottom: 10px; font-size: 12px; border: 1px solid #ffeeba; justify-content: space-between; align-items: center; }

        #chatArea { height: 300px; border: 1px solid #eee; border-radius: 8px; overflow-y: auto; padding: 15px; background: #fafafa; display: flex; flex-direction: column; margin-bottom: 10px; }
        .msg { margin-bottom: 10px; max-width: 85%; padding: 8px 12px; border-radius: 15px; font-size: 14px; display: flex; flex-direction: column; }
        .my-msg { align-self: flex-end !important; background-color: #007bff !important; color: white !important; margin-left: auto !important; }
        .their-msg { align-self: flex-start !important; background-color: #e5e5ea !important; color: black !important; margin-right: auto !important; }
        .dm-msg { border: 2px solid #6f42c1; }
        
        .msg-header { font-size: 11px; font-weight: bold; margin-bottom: 3px; display: block; }
        .typing-indicator { font-size: 12px; font-style: italic; color: #888; height: 20px; margin-bottom: 5px; }
        ul { list-style: none; padding: 0; }
        li { padding: 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .crown { color: #f1c40f; margin-right: 5px; }
    </style>
</head>
<body>

<div class="container">
    <h2>üõ† Room Control Center</h2>
    <div id="status" class="status offline">Connecting...</div>

    <div id="setupArea">
        <div class="card">
            <h3>User Identity</h3>
            <input type="text" id="nameInput" placeholder="Your Name" value="Browser Admin">
            <p style="font-size: 10px; color: #999;">UUID: <span id="uuidDisplay">...</span></p>
        </div>
        <div class="card">
            <h3>Create Session</h3>
            <input type="text" id="createIdInput" class="setup-input" placeholder="New Room ID">
            <button class="btn-create" onclick="createSession()">Create</button>
        </div>
        <div class="card">
            <h3>Join Session</h3>
            <input type="text" id="joinIdInput" class="setup-input" placeholder="Existing Room ID">
            <button class="btn-join" onclick="joinSession()">Join</button>
        </div>
    </div>

    <div id="roomArea" class="card" style="display:none;">
        <div id="dmIndicator" style="display: none; background: #6f42c1; color: white; padding: 8px; border-radius: 4px; margin-bottom: 10px; justify-content: space-between; align-items: center;">
            <span>Private: <strong id="dmTargetName"></strong></span>
            <button onclick="exitDM()" style="background: white; color: #6f42c1; padding: 2px 8px;">Back to Room</button>
        </div>

        <h3>Session: <span id="currentRoomDisplay"></span></h3>
        
        <div id="chatArea"></div>
        <div id="typingArea" class="typing-indicator"></div>

        <div id="editModeBar">
            <span>‚úèÔ∏è Editing message...</span>
            <button onclick="cancelEdit()" style="background:#dc3545; color:white; padding: 2px 8px;">Cancel</button>
        </div>
        
        <div style="display:flex; gap:10px;">
            <input type="text" id="chatInput" style="flex:1" placeholder="Type a message..." oninput="handleTyping()" onkeypress="if(event.key==='Enter') sendChat()">
            <button id="sendBtn" class="btn-send" onclick="sendChat()">Send</button>
        </div>

        <p style="margin-top:20px;"><b>Active Users:</b></p>
        <ul id="userList"></ul>
        <button style="width:100%; margin-top:15px; padding:10px; background:#6c757d; color:white;" onclick="location.reload()">üö™ Leave Session</button>
    </div>
</div>

<script>
    const socket = io();
    const myBrowserColor = '#1e8fff';
    
    let myUUID = localStorage.getItem('browser_uuid');
    if (!myUUID) {
        myUUID = 'browser-' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('browser_uuid', myUUID);
    }
    document.getElementById('uuidDisplay').innerText = myUUID;

    let myCurrentRoom = null;
    let activeDM = null; 
    let amIHost = false;
    let typingTimeout = null;
    let editingMsgID = null; // Track if we are currently editing

    socket.on('connect', () => {
        document.getElementById('status').innerText = "Connected: " + socket.id;
        document.getElementById('status').className = "status online";
    });

    // --- NEW: LISTENERS FOR EDITS/DELETES ---
    socket.on('message-edited', (data) => {
        const msgElement = document.querySelector(`[data-msg-id="${data.messageID}"]`);
        if (msgElement) {
            const textDiv = msgElement.querySelector('.msg-text');
            textDiv.innerText = data.newText;
            if (!msgElement.querySelector('.edited-indicator')) {
                const span = document.createElement('span');
                span.className = 'edited-indicator';
                span.innerText = '(edited)';
                textDiv.appendChild(span);
            }
        }
    });

    socket.on('message-deleted', (data) => {
        const msgElement = document.querySelector(`[data-msg-id="${data.messageID}"]`);
        if (msgElement) {
            // Keep the original alignment classes (my-msg or their-msg)
            // Just clear the inner content
            msgElement.innerHTML = `
                <span class="deleted-msg">${data.userName} deleted this message.</span>
            `;
            
            // Remove the action buttons so you can't edit a deleted message
            const actions = msgElement.querySelector('.msg-actions');
            if (actions) actions.remove();
        }
    });

    socket.on('receive-message', (data) => {
        const isMe = data.senderUUID === myUUID;
        if (isMe) return;

        const isDM = data.isDirectMessage === true || data.roomID.includes('_');

        if (isDM) {
            if (!activeDM) enterDM(data.senderUUID, data.sender);
            if (data.roomID === activeDM?.roomID) {
                displayMessage(data, false, true);
            }
        } else if (data.roomID === myCurrentRoom && !activeDM) {
            displayMessage(data, false, false);
        }
    });

    socket.on('user-typing', (data) => {
        if (data.roomID === (activeDM ? activeDM.roomID : myCurrentRoom)) {
            if (data.id !== socket.id) {
                document.getElementById('typingArea').innerText = `${data.name} is typing...`;
            }
        }
    });

    socket.on('user-stop-typing', (data) => {
        document.getElementById('typingArea').innerText = '';
    });

    socket.on('host-change', (newHostId) => {
        amIHost = (myUUID === newHostId);
    });

    socket.on('user-update', (users) => {
        const list = document.getElementById('userList');
        list.innerHTML = '';
        users.forEach(u => {
            const isMe = u.id === myUUID; 
            const li = document.createElement('li');
            
            li.innerHTML = `
                <div>${u.isHost ? '<span class="crown">üëë</span>' : ''} ${u.name} ${isMe ? '<i>(You)</i>' : ''}</div>
                <div>
                    ${!isMe ? `<button class="btn-dm" onclick="enterDM('${u.id}', '${u.name}')">DM</button>` : ''}
                    ${amIHost && !isMe ? `
                        <button class="btn-transfer" onclick="transferHost('${u.id}')">Promote</button>
                        <button class="btn-kick" onclick="removeUser('${u.id}')">Kick</button>
                    ` : ''}
                </div>
            `;
            list.appendChild(li);
        });
    });

    socket.on('removed-from-session', () => {
        alert("You have been removed from the session.");
        location.reload();
    });

    function createSession() {
        const roomID = document.getElementById('createIdInput').value.toUpperCase();
        if (!roomID) return;
        socket.emit('create-session', { roomID, existingUUID: myUUID }, () => setupUI(roomID));
    }

    function joinSession() {
        const roomID = document.getElementById('joinIdInput').value.toUpperCase();
        if (!roomID) return;
        socket.emit('join-session', { roomID, existingUUID: myUUID }, (res) => {
            if (res.exists) setupUI(roomID);
            else alert("Room not found");
        });
    }

    function setupUI(roomID) {
        myCurrentRoom = roomID;
        document.getElementById('setupArea').style.display = 'none';
        document.getElementById('roomArea').style.display = 'block';
        document.getElementById('currentRoomDisplay').innerText = roomID;
        const myName = document.getElementById('nameInput').value;

        socket.emit('update-user', { 
            name: myName, 
            uuid: myUUID, 
            sessionId: roomID,
            color: myBrowserColor,
        }, (response) => {
            if (response && response.uuid) {
                myUUID = response.uuid;
                document.getElementById('uuidDisplay').innerText = myUUID;
            }
        });
    }

    function enterDM(targetUUID, targetName) {
        const dmRoomID = [myUUID, targetUUID].sort().join('_');
        activeDM = { uuid: targetUUID, name: targetName, roomID: dmRoomID };
        socket.emit('join-dm', { dmRoomID, targetName: targetName });
        document.getElementById('dmIndicator').style.display = 'flex';
        document.getElementById('dmTargetName').innerText = targetName;
        document.getElementById('chatArea').innerHTML = ''; 
        document.getElementById('typingArea').innerText = '';
    }

    function exitDM() {
        activeDM = null;
        document.getElementById('dmIndicator').style.display = 'none';
        document.getElementById('chatArea').innerHTML = ''; 
    }

    function handleTyping() {
        socket.emit('typing', { 
            roomID: activeDM ? activeDM.roomID : myCurrentRoom, 
            name: document.getElementById('nameInput').value 
        });

        clearTimeout(typingTimeout);
        typingTimeout = setTimeout(() => {
            socket.emit('stop-typing', { roomID: activeDM ? activeDM.roomID : myCurrentRoom });
        }, 2000);
    }

    // --- UPDATED SEND LOGIC (Supports Editing) ---
    function sendChat() {
        const input = document.getElementById('chatInput');
        const text = input.value.trim();
        const myName = document.getElementById('nameInput').value;
        if (!text) return;

        if (editingMsgID) {
            // Emit edit event
            socket.emit('edit-message', {
                roomID: activeDM ? activeDM.roomID : myCurrentRoom,
                messageID: editingMsgID,
                newText: text
            });
            // Update UI locally
            const msgEl = document.querySelector(`[data-msg-id="${editingMsgID}"]`);
            if (msgEl) {
                msgEl.querySelector('.msg-text').innerText = text;
                if (!msgEl.querySelector('.edited-indicator')) {
                    const span = document.createElement('span');
                    span.className = 'edited-indicator';
                    span.innerText = ' (edited)';
                    msgEl.querySelector('.msg-text').appendChild(span);
                }
            }
            cancelEdit();
        } else {
            // Standard message logic
            const messageData = {
                id: 'msg-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9),
                roomID: activeDM ? activeDM.roomID : myCurrentRoom,
                sender: myName,
                senderUUID: myUUID,
                context: { text: text },
                color: myBrowserColor,
                serverTimestamp: Date.now(),
                isDM: !!activeDM
            };

            if (activeDM) {
                socket.emit('send-direct-message', {
                    id: messageData.id,
                    recipientUUID: activeDM.uuid,
                    context: messageData.context,
                    senderUUID: myUUID,
                    fromName: myName
                });
            } else {
                socket.emit('send-message', {
                    id: messageData.id,
                    roomID: myCurrentRoom,
                    context: messageData.context,
                    senderUUID: myUUID,
                    sender: myName
                });
            }
            displayMessage(messageData, true, !!activeDM);
        }

        input.value = '';
        socket.emit('stop-typing', { roomID: activeDM ? activeDM.roomID : myCurrentRoom });
    }

    // --- NEW: EDIT/DELETE HANDLERS ---
    function prepareEdit(msgID, currentText) {
        editingMsgID = msgID;
        document.getElementById('chatInput').value = currentText;
        document.getElementById('editModeBar').style.display = 'flex';
        document.getElementById('sendBtn').innerText = 'Save';
        document.getElementById('chatInput').focus();
    }

    function cancelEdit() {
        editingMsgID = null;
        document.getElementById('chatInput').value = '';
        document.getElementById('editModeBar').style.display = 'none';
        document.getElementById('sendBtn').innerText = 'Send';
    }

    function confirmDelete(msgID) {
        if (confirm("Delete this message?")) {
            socket.emit('delete-message', {
                roomID: activeDM ? activeDM.roomID : myCurrentRoom,
                messageID: msgID,
                userName: document.getElementById('nameInput').value
            });
            
            const msgEl = document.querySelector(`[data-msg-id="${msgID}"]`);
            if (msgEl) {
                // We keep 'my-msg' class so it stays on the right
                msgEl.innerHTML = `<span class="deleted-msg">You deleted this message.</span>`;
                // Optional: reduce opacity to make it look "gone"
                msgEl.style.opacity = "0.6";
            }
        }
    }
    
    function transferHost(targetId) {
        if(confirm("Promote this user to host?")) {
            socket.emit('transfer-host', { roomID: myCurrentRoom, newHostUUID: targetId });
        }
    }

    function removeUser(targetId) {
        if(confirm("Remove this user from the session?")) {
            socket.emit('remove-user', { roomID: myCurrentRoom, userUUIDToRemove: targetId });
        }
    }

    function displayMessage(data, amISender, isDM) {
        const chatArea = document.getElementById('chatArea');
        if (data.id && document.querySelector(`[data-msg-id="${data.id}"]`)) return;

        const div = document.createElement('div');
        div.className = `msg ${amISender ? 'my-msg' : 'their-msg'} ${isDM ? 'dm-msg' : ''}`;
        if (data.id) div.setAttribute('data-msg-id', data.id);
        
        const messageText = data.context?.text || data.text || "...";
        const senderName = amISender ? "You" : data.sender;
        
        div.innerHTML = `
            <span style="font-size: 10px; font-weight: bold; margin-bottom: 2px; opacity: 0.8;">
                ${isDM ? 'üîí ' : ''}${senderName}
            </span>
            <div class="msg-text">${messageText}</div>
            ${amISender ? `
                <div class="msg-actions">
                    <button class="btn-msg-action" onclick="prepareEdit('${data.id}', '${messageText.replace(/'/g, "\\'")}')">Edit</button>
                    <button class="btn-msg-action" onclick="confirmDelete('${data.id}')">Delete</button>
                </div>
            ` : ''}
        `;
        
        chatArea.appendChild(div);
        chatArea.scrollTop = chatArea.scrollHeight;
    }
</script>
</body>
</html>