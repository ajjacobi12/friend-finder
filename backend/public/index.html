<!DOCTYPE html>
<html>
<head>
    <title>Socket Master Dashboard</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 30px; background-color: #f4f4f9; display: flex; flex-direction: column; align-items: center; }
        .container { width: 100%; max-width: 550px; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .status { padding: 10px; margin-bottom: 20px; border-radius: 6px; text-align: center; font-weight: bold; }
        .online { background: #d4edda; color: #155724; }
        .offline { background: #f8d7da; color: #721c24; }
        .card { border-top: 2px solid #eee; padding-top: 15px; margin-top: 15px; }
        
        input { padding: 10px; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 10px; }
        .setup-input { width: 70%; }
        
        button { padding: 8px 12px; cursor: pointer; border: none; border-radius: 4px; font-weight: bold; font-size: 12px; transition: 0.2s; }
        .btn-create { background: #28a745; color: white; }
        .btn-join { background: #007bff; color: white; }
        .btn-send { background: #007bff; color: white; padding: 10px 20px; }
        
        .btn-kick { background: #dc3545; color: white; margin-left: 5px; }
        .btn-transfer { background: #f39c12; color: white; margin-left: 5px; }
        .btn-dm { background: #6f42c1; color: white; margin-left: 5px; }

        #chatArea { height: 300px; border: 1px solid #eee; border-radius: 8px; overflow-y: auto; padding: 15px; background: #fafafa; display: flex; flex-direction: column; margin-bottom: 10px; }
        .msg { margin-bottom: 10px; max-width: 85%; padding: 8px 12px; border-radius: 15px; font-size: 14px; display: flex; flex-direction: column; }
        .my-msg { align-self: flex-end !important; background-color: #007bff !important; color: white !important; margin-left: auto !important; }
        .their-msg { align-self: flex-start !important; background-color: #e5e5ea !important; color: black !important; margin-right: auto !important; }
        .dm-msg { border: 2px solid #6f42c1; }
        
        .msg-header { font-size: 11px; font-weight: bold; margin-bottom: 3px; display: block; }
        .typing-indicator { font-size: 12px; font-style: italic; color: #888; height: 20px; margin-bottom: 5px; }
        ul { list-style: none; padding: 0; }
        li { padding: 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .crown { color: #f1c40f; margin-right: 5px; }
    </style>
</head>
<body>

<div class="container">
    <h2>ðŸ›  Room Control Center</h2>
    <div id="status" class="status offline">Connecting...</div>

    <div id="setupArea">
        <div class="card">
            <h3>User Identity</h3>
            <input type="text" id="nameInput" placeholder="Your Name" value="Browser Admin">
            <p style="font-size: 10px; color: #999;">UUID: <span id="uuidDisplay">...</span></p>
        </div>
        <div class="card">
            <h3>Create Session</h3>
            <input type="text" id="createIdInput" class="setup-input" placeholder="New Room ID">
            <button class="btn-create" onclick="createSession()">Create</button>
        </div>
        <div class="card">
            <h3>Join Session</h3>
            <input type="text" id="joinIdInput" class="setup-input" placeholder="Existing Room ID">
            <button class="btn-join" onclick="joinSession()">Join</button>
        </div>
    </div>

    <div id="roomArea" class="card" style="display:none;">
        <div id="dmIndicator" style="display: none; background: #6f42c1; color: white; padding: 8px; border-radius: 4px; margin-bottom: 10px; justify-content: space-between; align-items: center;">
            <span>Private: <strong id="dmTargetName"></strong></span>
            <button onclick="exitDM()" style="background: white; color: #6f42c1; padding: 2px 8px;">Back to Room</button>
        </div>

        <h3>Session: <span id="currentRoomDisplay"></span></h3>
        
        <div id="chatArea"></div>
        <div id="typingArea" class="typing-indicator"></div>
        
        <div style="display:flex; gap:10px;">
            <input type="text" id="chatInput" style="flex:1" placeholder="Type a message..." oninput="handleTyping()" onkeypress="if(event.key==='Enter') sendChat()">
            <button class="btn-send" onclick="sendChat()">Send</button>
        </div>

        <p style="margin-top:20px;"><b>Active Users:</b></p>
        <ul id="userList"></ul>
        <button style="width:100%; margin-top:15px; padding:10px; background:#6c757d; color:white;" onclick="location.reload()">ðŸšª Leave Session</button>
    </div>
</div>

<script>
    const socket = io();
    const myBrowserColor = '#1e8fff';
    
    // --- IDENTITY LOGIC ---
    // Generate or retrieve a persistent UUID for the browser session
    let myUUID = localStorage.getItem('browser_uuid');
    if (!myUUID) {
        myUUID = 'browser-' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('browser_uuid', myUUID);
    }
    document.getElementById('uuidDisplay').innerText = myUUID;

    let myCurrentRoom = null;
    let activeDM = null; // { uuid, name, roomID }
    let amIHost = false;
    let typingTimeout = null;

    socket.on('connect', () => {
        document.getElementById('status').innerText = "Connected: " + socket.id;
        document.getElementById('status').className = "status online";
    });

    // --- MESSAGE LOGIC ---
    socket.on('receive-message', (data) => {
        console.log("ðŸ“¨ Incoming:", data);
        // console.log("browser UUID: ", myUUID);

        // 1. Identify Sender
        const isMe = data.senderUUID === myUUID;

        // 2. STOP if it's our own message (prevents doubling)
        if (isMe) return;

        // 3. Logic based on your log: isDirectMessage
        const isDM = data.isDirectMessage === true || data.roomID.includes('_');

        if (isDM) {
            if (!activeDM) enterDM(data.senderUUID, data.sender);
            if (data.roomID === activeDM?.roomID) {
                displayMessage(data, false, true);
            }
        } else if (data.roomID === myCurrentRoom && !activeDM) {
            displayMessage(data, false, false);
        }
    });

    // --- TYPING INDICATORS ---
    socket.on('user-typing', (data) => {
        if (data.roomID === (activeDM ? activeDM.roomID : myCurrentRoom)) {
            if (data.id !== socket.id) {
                document.getElementById('typingArea').innerText = `${data.name} is typing...`;
            }
        }
    });

    socket.on('user-stop-typing', (data) => {
        document.getElementById('typingArea').innerText = '';
    });

    socket.on('host-change', (newHostId) => {
        amIHost = (myUUID === newHostId);
    });

    socket.on('user-update', (users) => {
        const list = document.getElementById('userList');
        list.innerHTML = '';
        users.forEach(u => {
            const isMe = u.id === myUUID; // Using UUID for identification
            const li = document.createElement('li');
            
            li.innerHTML = `
                <div>${u.isHost ? '<span class="crown">ðŸ‘‘</span>' : ''} ${u.name} ${isMe ? '<i>(You)</i>' : ''}</div>
                <div>
                    ${!isMe ? `<button class="btn-dm" onclick="enterDM('${u.id}', '${u.name}')">DM</button>` : ''}
                    ${amIHost && !isMe ? `
                        <button class="btn-transfer" onclick="transferHost('${u.id}')">Promote</button>
                        <button class="btn-kick" onclick="removeUser('${u.id}')">Kick</button>
                    ` : ''}
                </div>
            `;
            list.appendChild(li);
        });
    });

    socket.on('removed-from-session', () => {
        alert("You have been removed from the session.");
        location.reload();
    });

    // --- ACTIONS ---
    function createSession() {
        const roomID = document.getElementById('createIdInput').value.toUpperCase();
        if (!roomID) return;
        const payload = {
            roomID: roomID,
            existingUUID: myUUID // Passing this helps the server recognize the browser
        };
        socket.emit('create-session', payload, () => setupUI(roomID));
    }

    function joinSession() {
        const roomID = document.getElementById('joinIdInput').value.toUpperCase();
        if (!roomID) return;
        const payload = {
            roomID: roomID,
            existingUUID: myUUID // Passing this helps the server recognize the browser
        };
        socket.emit('join-session', payload, (res) => {
            if (res.exists) setupUI(roomID);
            else alert("Room not found");
        });
    }

    function setupUI(roomID) {
        myCurrentRoom = roomID;
        document.getElementById('setupArea').style.display = 'none';
        document.getElementById('roomArea').style.display = 'block';
        document.getElementById('currentRoomDisplay').innerText = roomID;
        
        // 1. Get our name
        const myName = document.getElementById('nameInput').value;
        // console.log("setting up user");

        // 2. Register with the server
        socket.emit('update-user', { 
            name: myName, 
            uuid: myUUID, // We send our browser ID...
            sessionId: roomID,
            color: myBrowserColor,
        }, (response) => {
            // console.log("response: ", response);
            // 3. THE FIX: If the server says "No, your ID is actually X", 
            // we update our local variable to match.
            if (response && response.uuid) {
                myUUID = response.uuid;
                document.getElementById('uuidDisplay').innerText = myUUID;
                // console.log("Updated local UUID to match server:", myUUID);
            }
        });
    }

    function enterDM(targetUUID, targetName) {
        // Build the same DM Room ID logic as the phone app
        const dmRoomID = [myUUID, targetUUID].sort().join('_');
        activeDM = { uuid: targetUUID, name: targetName, roomID: dmRoomID };
        console.log("active DM: ", activeDM);
        
        socket.emit('join-dm', { dmRoomID, targetName: targetName });
        
        document.getElementById('dmIndicator').style.display = 'flex';
        document.getElementById('dmTargetName').innerText = targetName;
        document.getElementById('chatArea').innerHTML = ''; 
        document.getElementById('typingArea').innerText = '';
    }

    function exitDM() {
        activeDM = null;
        document.getElementById('dmIndicator').style.display = 'none';
        document.getElementById('chatArea').innerHTML = ''; 
    }

    function handleTyping() {
        socket.emit('typing', { 
            roomID: activeDM ? activeDM.roomID : myCurrentRoom, 
            name: document.getElementById('nameInput').value 
        });

        clearTimeout(typingTimeout);
        typingTimeout = setTimeout(() => {
            socket.emit('stop-typing', { roomID: activeDM ? activeDM.roomID : myCurrentRoom });
        }, 2000);
    }

    function sendChat() {
        const input = document.getElementById('chatInput');
        const text = input.value.trim();
        const myName = document.getElementById('nameInput').value;
        if (!text) return;

        const messageData = {
            id: 'msg-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9),
            roomID: activeDM ? activeDM.roomID : myCurrentRoom,
            sender: myName,
            senderUUID: myUUID,
            context: { 
                text: text,
                isEncrypted: false,
                version: "1.0"
            },
            color: '#1e8fff',
            serverTimestamp: Date.now(),
            isDM: !!activeDM
        };
        console.log("messageData from browser: ", messageData);

        if (activeDM) {
            socket.emit('send-direct-message', {
                id: messageData.id,
                recipientUUID: activeDM.uuid,
                context: messageData.context,
                senderUUID: myUUID,
                fromName: myName
            });
            console.log("in socket.emit from browser: ", activeDM.uuid, messageData.context, myUUID, myName);
        } else {
            socket.emit('send-message', {
                id: messageData.id,
                roomID: myCurrentRoom,
                context: messageData.context,
                senderUUID: myUUID,
                sender: myName
            });
        }
        
        // Optimistic display
        displayMessage(messageData, true, !!activeDM);
        input.value = '';
        socket.emit('stop-typing', { roomID: activeDM ? activeDM.roomID : myCurrentRoom });
    }
    
    function transferHost(targetId) {
        if(confirm("Promote this user to host?")) {
            socket.emit('transfer-host', { roomID: myCurrentRoom, newHostUUID: targetId });
        }
    }

    function removeUser(targetId) {
        if(confirm("Remove this user from the session?")) {
            socket.emit('remove-user', { roomID: myCurrentRoom, userUUIDToRemove: targetId });
        }
    }

    function displayMessage(data, amISender, isDM) {
        console.log("displayMessage parameters from browser: ", data, amISender, isDM);
        const chatArea = document.getElementById('chatArea');
        
        // Safety check for duplicates
        if (data.id && document.querySelector(`[data-msg-id="${data.id}"]`)) return;

        const div = document.createElement('div');
        div.className = `msg ${amISender ? 'my-msg' : 'their-msg'} ${isDM ? 'dm-msg' : ''}`;
        if (data.id) div.setAttribute('data-msg-id', data.id);
        
        // Match your log: data.context.text
        const messageText = data.context?.text || data.text || "...";
        const senderName = amISender ? "You" : data.sender;
        
        div.innerHTML = `
            <span style="font-size: 10px; font-weight: bold; margin-bottom: 2px; opacity: 0.8;">
                ${isDM ? 'ðŸ”’ ' : ''}${senderName}
            </span>
            <div>${messageText}</div>
        `;
        
        chatArea.appendChild(div);
        chatArea.scrollTop = chatArea.scrollHeight;
    }
</script>
</body>
</html>