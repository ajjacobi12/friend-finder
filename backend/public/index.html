<!DOCTYPE html>
<html>
<head>
    <title>Socket Master Dashboard</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 30px; background-color: #f4f4f9; display: flex; flex-direction: column; align-items: center; }
        .container { width: 100%; max-width: 550px; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .status { padding: 10px; margin-bottom: 20px; border-radius: 6px; text-align: center; font-weight: bold; }
        .online { background: #d4edda; color: #155724; }
        .offline { background: #f8d7da; color: #721c24; }
        .card { border-top: 2px solid #eee; padding-top: 15px; margin-top: 15px; }
        
        input { padding: 10px; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 10px; }
        .setup-input { width: 70%; }
        
        button { padding: 8px 12px; cursor: pointer; border: none; border-radius: 4px; font-weight: bold; font-size: 12px; transition: 0.2s; }
        .btn-create { background: #28a745; color: white; }
        .btn-join { background: #007bff; color: white; }
        .btn-send { background: #007bff; color: white; padding: 10px 20px; }
        
        /* Host/DM Buttons */
        .btn-kick { background: #dc3545; color: white; margin-left: 5px; }
        .btn-transfer { background: #f39c12; color: white; margin-left: 5px; }
        .btn-dm { background: #6f42c1; color: white; margin-left: 5px; }

        #chatArea { height: 250px; border: 1px solid #eee; border-radius: 8px; overflow-y: auto; padding: 15px; background: #fafafa; display: flex; flex-direction: column; margin-bottom: 10px; }
        .msg { margin-bottom: 10px; max-width: 85%; padding: 8px 12px; border-radius: 15px; font-size: 14px; line-height: 1.4; }
        .my-msg { align-self: flex-end; background: #007bff20; border: 1px solid #007bff40; }
        .their-msg { align-self: flex-start; background: #e5e5ea; }
        .dm-msg { border: 1px dashed #6f42c1; background: #fdfcfe; }
        
        .msg-header { font-size: 11px; font-weight: bold; margin-bottom: 3px; display: block; }
        ul { list-style: none; padding: 0; }
        li { padding: 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .crown { color: #f1c40f; margin-right: 5px; }
    </style>
</head>
<body>

<div class="container">
    <h2>ðŸ›  Room Control Center</h2>
    <div id="status" class="status offline">Connecting...</div>

    <div id="setupArea">
        <div class="card">
            <h3>User Identity</h3>
            <input type="text" id="nameInput" placeholder="Your Name" value="Browser User">
            <input type="hidden" id="colorInput" value="#1e8fff"> 
        </div>
        <div class="card">
            <h3>Create Session</h3>
            <input type="text" id="createIdInput" class="setup-input" placeholder="New Room ID">
            <button class="btn-create" onclick="createSession()">Create</button>
        </div>
        <div class="card">
            <h3>Join Session</h3>
            <input type="text" id="joinIdInput" class="setup-input" placeholder="Existing Room ID">
            <button class="btn-join" onclick="joinSession()">Join</button>
        </div>
    </div>

    <div id="roomArea" class="card" style="display:none;">
        <div id="dmIndicator" style="display: none; background: #6f42c1; color: white; padding: 8px; border-radius: 4px; margin-bottom: 10px; justify-content: space-between; align-items: center;">
            <span>Private: <strong id="dmTargetName"></strong></span>
            <button onclick="exitDM()" style="background: white; color: #6f42c1; padding: 2px 8px;">Back to Room</button>
        </div>

        <h3>Session: <span id="currentRoomDisplay"></span></h3>
        <div id="chatArea"></div>
        
        <div style="display:flex; gap:10px;">
            <input type="text" id="chatInput" style="flex:1" placeholder="Type a message..." onkeypress="if(event.key==='Enter') sendChat()">
            <button class="btn-send" onclick="sendChat()">Send</button>
        </div>

        <p style="margin-top:20px;"><b>Active Users:</b></p>
        <ul id="userList"></ul>
        <button style="width:100%; margin-top:15px; padding:10px; background:#6c757d; color:white;" onclick="location.reload()">ðŸšª Leave Session</button>
    </div>
</div>

<script>
    const socket = io();
    let myCurrentRoom = null;
    let activeDM = null; // { id, name, roomID }
    let amIHost = false;

    socket.on('connect', () => {
        document.getElementById('status').innerText = "Connected: " + socket.id;
        document.getElementById('status').className = "status online";
    });

    // --- MESSAGE LOGIC ---
    socket.on('receive-message', (data) => {
        console.log("ðŸ“¨ Data received in browser:", data);

        if (data.isDirectMessage) {
            // 1. If we aren't in a DM window, open it automatically for the new sender
            if (!activeDM) {
                // 'data.id' is the socket ID of the phone user
                enterDM(data.id, data.sender || "Phone User");
            }
            
            // 2. Display the message
            // We verify: Is it from the person we are looking at? OR is it from us?
            const isFromActivePartner = (data.id === activeDM?.id);
            const isFromMe = (data.id === socket.id);

            if (isFromActivePartner || isFromMe) {
                displayMessage(data, isFromMe, true);
            }
        } 
        else if (data.roomID === myCurrentRoom && !activeDM) {
            // Group message logic
            displayMessage(data, data.id === socket.id, false);
        }
    });
    
    // --- HOST & USER UPDATES ---
    socket.on('host-change', (newHostId) => {
        amIHost = (socket.id === newHostId);
    });

    socket.on('user-update', (users) => {
        const list = document.getElementById('userList');
        list.innerHTML = '';
        users.forEach(u => {
            const isMe = u.id === socket.id;
            const li = document.createElement('li');
            
            li.innerHTML = `
                <div>${u.isHost ? '<span class="crown">ðŸ‘‘</span>' : ''} ${u.name} ${isMe ? '<i>(You)</i>' : ''}</div>
                <div>
                    ${!isMe ? `<button class="btn-dm" onclick="enterDM('${u.id}', '${u.name}')">DM</button>` : ''}
                    ${amIHost && !isMe ? `
                        <button class="btn-transfer" onclick="transferHost('${u.id}')">Promote</button>
                        <button class="btn-kick" onclick="removeUser('${u.id}')">Kick</button>
                    ` : ''}
                </div>
            `;
            list.appendChild(li);
        });
    });

    socket.on('removed-from-session', () => {
        alert("You have been removed from the session.");
        location.reload();
    });

    // --- FUNCTIONS ---
    function createSession() {
        const roomID = document.getElementById('createIdInput').value.toUpperCase();
        if (!roomID) return;
        socket.emit('create-session', roomID, () => setupUI(roomID));
    }

    function joinSession() {
        const roomID = document.getElementById('joinIdInput').value.toUpperCase();
        if (!roomID) return;
        socket.emit('join-session', roomID, (res) => {
            if (res.exists) setupUI(roomID);
            else alert("Room not found");
        });
    }

    function setupUI(roomID) {
        myCurrentRoom = roomID;
        document.getElementById('setupArea').style.display = 'none';
        document.getElementById('roomArea').style.display = 'block';
        document.getElementById('currentRoomDisplay').innerText = roomID;
        socket.emit('update-user', { 
            name: document.getElementById('nameInput').value, 
            color: '#1e8fff', 
            sessionId: roomID 
        });
    }

    function enterDM(id, name) {
        const dmRoomID = [socket.id, id].sort().join('_');
        activeDM = { id, name, roomID: dmRoomID };
        socket.emit('join-dm', { dmRoomID, targetName: name });
        document.getElementById('dmIndicator').style.display = 'flex';
        document.getElementById('dmTargetName').innerText = name;
        document.getElementById('chatArea').innerHTML = ''; // Clear for private view
    }

    function exitDM() {
        activeDM = null;
        document.getElementById('dmIndicator').style.display = 'none';
        document.getElementById('chatArea').innerHTML = ''; 
    }

function sendChat() {
        const input = document.getElementById('chatInput');
        const text = input.value.trim();
        const myName = document.getElementById('nameInput').value;
        if (!text) return;

        if (activeDM) {
            // 1. Send to server
            socket.emit('send-direct-message', {
                recipientId: activeDM.id,
                context: { text },
                fromName: myName
            });

            // 2. FIX: Display the message on your own screen immediately!
            displayMessage({ 
                sender: myName, 
                color: '#1e8fff', 
                context: { text },
                id: socket.id // Identify as me
            }, true, true);

        } else {
            // Group Chat logic
            socket.emit('send-message', {
                roomID: myCurrentRoom,
                context: { text },
                sender: myName
            });
            displayMessage({ sender: myName, color: '#1e8fff', context: { text } }, true, false);
        }
        input.value = '';
    }

    // MATCHES SERVER: {roomID, newHostId}
    function transferHost(targetId) {
        if(confirm("Promote this user to host?")) {
            socket.emit('transfer-host', { roomID: myCurrentRoom, newHostId: targetId });
        }
    }

    // MATCHES SERVER: {roomID, userIdToRemove}
    function removeUser(targetId) {
        if(confirm("Remove this user from the session?")) {
            socket.emit('remove-user', { roomID: myCurrentRoom, userIdToRemove: targetId });
        }
    }

    function displayMessage(data, isMe, isDM) {
        const chatArea = document.getElementById('chatArea');
        const div = document.createElement('div');
        
        // Check if message is mine using data.id (server) or data.sender (group)
        const amISender = isMe || (data.id === socket.id);
        
        div.className = `msg ${amISender ? 'my-msg' : 'their-msg'} ${isDM ? 'dm-msg' : ''}`;
        
        // Get text safely
        const text = data.context ? data.context.text : '...';
        
        div.innerHTML = `
            <span class="msg-header" style="color:${data.color || '#000'}">
                ${isDM ? 'ðŸ”’ ' : ''}${data.sender}
            </span>
            ${text}
        `;
        
        chatArea.appendChild(div);
        chatArea.scrollTop = chatArea.scrollHeight;
    }
</script>
</body>
</html>