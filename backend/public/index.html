<!DOCTYPE html>
<html>
<head>
    <title>Socket Master Dashboard</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 30px; background-color: #f4f4f9; display: flex; flex-direction: column; align-items: center; }
        .container { width: 100%; max-width: 550px; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .status { padding: 10px; margin-bottom: 20px; border-radius: 6px; text-align: center; font-weight: bold; }
        .online { background: #d4edda; color: #155724; }
        .offline { background: #f8d7da; color: #721c24; }
        .card { border-top: 2px solid #eee; padding-top: 15px; margin-top: 15px; }
        
        input { padding: 10px; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 10px; }
        .setup-input { width: 70%; }
        
        button { padding: 8px 12px; cursor: pointer; border: none; border-radius: 4px; font-weight: bold; font-size: 12px; transition: 0.2s; }
        .btn-create { background: #28a745; color: white; }
        .btn-join { background: #007bff; color: white; }
        .btn-send { background: #007bff; color: white; padding: 10px 20px; }
        
        .btn-kick { background: #dc3545; color: white; margin-left: 5px; }
        .btn-transfer { background: #f39c12; color: white; margin-left: 5px; }
        .btn-dm { background: #6f42c1; color: white; margin-left: 5px; }

        /* --- Color Picker Styles --- */
        .color-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 8px; margin-top: 10px; margin-bottom: 15px; }
        .color-circle { width: 35px; height: 35px; border-radius: 50%; cursor: pointer; border: 3px solid transparent; transition: 0.1s; }
        .color-circle:hover { transform: scale(1.1); }
        .color-circle.selected { border-color: #333; box-shadow: 0 0 8px rgba(0,0,0,0.2); }

        /* --- Chat Styles --- */
        .msg-actions { display: none; margin-top: 5px; border-top: 1px solid rgba(255,255,255,0.2); padding-top: 4px; gap: 8px; }
        .my-msg:hover .msg-actions { display: flex; }
        .btn-msg-action { background: none; border: 1px solid white; color: white; padding: 2px 6px; font-size: 9px; opacity: 0.8; }
        .btn-msg-action:hover { opacity: 1; background: rgba(255,255,255,0.1); }
        .edited-indicator { font-size: 10px; font-style: italic; opacity: 0.7; margin-left: 5px; }
        .deleted-msg { font-style: italic; opacity: 0.5; }
        #editModeBar { display: none; background: #fff3cd; padding: 8px; border-radius: 4px; margin-bottom: 10px; font-size: 12px; border: 1px solid #ffeeba; justify-content: space-between; align-items: center; }

        #chatArea { height: 300px; border: 1px solid #eee; border-radius: 8px; overflow-y: auto; padding: 15px; background: #fafafa; display: flex; flex-direction: column; margin-bottom: 10px; }
        .msg { margin-bottom: 10px; max-width: 85%; padding: 8px 12px; border-radius: 15px; font-size: 14px; display: flex; flex-direction: column; }
        .my-msg { align-self: flex-end !important; background-color: #007bff !important; color: white !important; margin-left: auto !important; }
        .their-msg { align-self: flex-start !important; background-color: #e5e5ea !important; color: black !important; margin-right: auto !important; }
        .dm-msg { border: 2px solid #6f42c1; }
        
        .typing-indicator { font-size: 12px; font-style: italic; color: #888; height: 20px; margin-bottom: 5px; }
        ul { list-style: none; padding: 0; }
        li { padding: 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .crown { color: #f1c40f; margin-right: 5px; }
    </style>
</head>
<body>

<div class="container">
    <h2>üõ† Room Control Center</h2>
    <div id="status" class="status offline">Connecting...</div>

    <div id="setupArea">
        <div class="card">
            <h3>User Identity</h3>
            <input type="text" id="nameInput" placeholder="Your Name" value="Browser Admin">
            <p style="font-size: 10px; color: #999;">UUID: <span id="uuidDisplay">...</span></p>
        </div>
        <div class="card">
            <h3>Create Session</h3>
            <input type="text" id="createIdInput" class="setup-input" placeholder="New Room ID">
            <button class="btn-create" onclick="createSession()">Create</button>
        </div>
        <div class="card">
            <h3>Join Session</h3>
            <input type="text" id="joinIdInput" class="setup-input" placeholder="Existing Room ID">
            <button class="btn-join" onclick="joinSession()">Join</button>
        </div>
    </div>

    <div id="roomArea" class="card" style="display:none;">
        <div id="dmIndicator" style="display: none; background: #6f42c1; color: white; padding: 8px; border-radius: 4px; margin-bottom: 10px; justify-content: space-between; align-items: center;">
            <span>Private: <strong id="dmTargetName"></strong></span>
            <button onclick="exitDM()" style="background: white; color: #6f42c1; padding: 2px 8px;">Back to Room</button>
        </div>

        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h3>Session: <span id="currentRoomDisplay"></span></h3>
            <button style="background:#6c757d; color:white;" onclick="location.reload()">üö™ Leave</button>
        </div>

        <div class="card" style="border: 1px solid #eee; padding: 10px; border-radius: 8px; background: #fff; margin-bottom: 10px;">
            <p style="margin: 0 0 5px 0; font-size: 12px; font-weight: bold; color: #555;">Your Color:</p>
            <div id="roomColorGrid" class="color-grid"></div>
        </div>
        
        <div id="chatArea"></div>
        <div id="typingArea" class="typing-indicator"></div>

        <div id="editModeBar">
            <span>‚úèÔ∏è Editing message...</span>
            <button onclick="cancelEdit()" style="background:#dc3545; color:white; padding: 2px 8px;">Cancel</button>
        </div>
        
        <div style="display:flex; gap:10px;">
            <input type="text" id="chatInput" style="flex:1" placeholder="Type a message..." oninput="handleTyping()" onkeypress="if(event.key==='Enter') sendChat()">
            <button id="sendBtn" class="btn-send" onclick="sendChat()">Send</button>
        </div>

        <p style="margin-top:20px;"><b>Active Users:</b></p>
        <ul id="userList"></ul>
    </div>
</div>

<script>
    const socket = io();
    const colorOptions = ['#a0220c', '#2e8b56', '#1e8fff', '#ffd900', '#8824ec', '#2ec4ff', '#ff9500', '#095517', '#ff00f7', '#091490', '#09f34f', '#ff0000'];
    let myBrowserColor = '#1e8fff';
    
    let myUUID = localStorage.getItem('browser_uuid');
    if (!myUUID) {
        myUUID = 'browser-' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('browser_uuid', myUUID);
    }
    document.getElementById('uuidDisplay').innerText = myUUID;

    let myCurrentRoom = null;
    let activeDM = null; 
    let amIHost = false;
    let typingTimeout = null;
    let editingMsgID = null;

    // --- COLOR PICKER ---
    function renderColorPicker() {
        const grid = document.getElementById('roomColorGrid');
        grid.innerHTML = '';
        colorOptions.forEach(color => {
            const circle = document.createElement('div');
            circle.className = `color-circle ${color === myBrowserColor ? 'selected' : ''}`;
            circle.style.backgroundColor = color;
            circle.onclick = () => {
                myBrowserColor = color;
                renderColorPicker(); 
                syncUserUpdate();
            };
            grid.appendChild(circle);
        });
    }

    function syncUserUpdate() {
        if (!myCurrentRoom) return;
        socket.emit('update-user', { 
            name: document.getElementById('nameInput').value, 
            uuid: myUUID, 
            sessionId: myCurrentRoom,
            color: myBrowserColor
        });
    }

    // --- SOCKET LISTENERS ---
    socket.on('connect', () => {
        document.getElementById('status').innerText = "Connected";
        document.getElementById('status').className = "status online";
    });

    socket.on('message-edited', (data) => {
        const msgElement = document.querySelector(`[data-msg-id="${data.messageID}"]`);
        if (msgElement) {
            const textDiv = msgElement.querySelector('.msg-text');
            textDiv.innerText = data.newText;
            if (!msgElement.querySelector('.edited-indicator')) {
                const span = document.createElement('span');
                span.className = 'edited-indicator';
                span.innerText = '(edited)';
                textDiv.appendChild(span);
            }
        }
    });

    socket.on('message-deleted', (data) => {
        const msgElement = document.querySelector(`[data-msg-id="${data.messageID}"]`);
        if (msgElement) {
            msgElement.innerHTML = `<span class="deleted-msg">${data.userName} deleted this message.</span>`;
            if (msgElement.querySelector('.msg-actions')) msgElement.querySelector('.msg-actions').remove();
        }
    });

    socket.on('receive-message', (data) => {
        const isMe = data.senderUUID === myUUID;
        if (isMe) return;
        const isDM = data.isDirectMessage === true || data.roomID.includes('_');
        if (isDM) {
            if (!activeDM) enterDM(data.senderUUID, data.sender);
            if (data.roomID === activeDM?.roomID) displayMessage(data, false, true);
        } else if (data.roomID === myCurrentRoom && !activeDM) {
            displayMessage(data, false, false);
        }
    });

    socket.on('user-typing', (data) => {
        if (data.roomID === (activeDM ? activeDM.roomID : myCurrentRoom)) {
            if (data.id !== socket.id) document.getElementById('typingArea').innerText = `${data.name} is typing...`;
        }
    });

    socket.on('user-stop-typing', () => document.getElementById('typingArea').innerText = '');

    socket.on('host-change', (newHostId) => { amIHost = (myUUID === newHostId); });

    socket.on('user-update', (users) => {
        const list = document.getElementById('userList');
        list.innerHTML = '';

        // 1. Reset (Corrected Casing)
        amIHost = false; 

        // 2. Find "Me" first to set the host flag correctly for this render cycle
        const me = users.find(u => u.id === myUUID);
        if (me && me.isHost) amIHost = true;

        // 3. Now render everyone
        users.forEach(u => {
            const isMe = u.id === myUUID; 
            
            const li = document.createElement('li');
            li.innerHTML = `
                <div style="display:flex; align-items:center;">
                    <div style="width:12px; height:12px; border-radius:50%; background:${u.color}; margin-right:8px; border:1px solid #ccc;"></div>
                    ${u.isHost ? '<span class="crown">üëë</span>' : ''} ${u.name} ${isMe ? '<i>(You)</i>' : ''}
                </div>
                <div>
                    ${!isMe ? `<button class="btn-dm" onclick="enterDM('${u.id}', '${u.name}')">DM</button>` : ''}
                    ${amIHost && !isMe ? `
                        <button class="btn-transfer" onclick="transferHost('${u.id}')">Promote</button>
                        <button class="btn-kick" onclick="removeUser('${u.id}')">Kick</button>
                    ` : ''}
                </div>
            `;
            list.appendChild(li);
        });
    });

    socket.on('removed-from-session', () => { alert("Removed from session."); location.reload(); });

    // --- ACTIONS ---
    function createSession() {
        const roomID = document.getElementById('createIdInput').value.toUpperCase();
        if (!roomID) return;
        socket.emit('create-session', { roomID, existingUUID: myUUID }, () => setupUI(roomID));
    }

    function joinSession() {
        const roomID = document.getElementById('joinIdInput').value.toUpperCase();
        if (!roomID) return;
        socket.emit('join-session', { roomID, existingUUID: myUUID }, (res) => {
            if (res.exists) setupUI(roomID);
            else alert("Room not found");
        });
    }

    function setupUI(roomID) {
        myCurrentRoom = roomID;
        document.getElementById('setupArea').style.display = 'none';
        document.getElementById('roomArea').style.display = 'block';
        document.getElementById('currentRoomDisplay').innerText = roomID;
        renderColorPicker();
        syncUserUpdate();
    }

    function enterDM(targetUUID, targetName) {
        const dmRoomID = [myUUID, targetUUID].sort().join('_');
        activeDM = { uuid: targetUUID, name: targetName, roomID: dmRoomID };
        socket.emit('join-dm', { dmRoomID, targetName: targetName });
        document.getElementById('dmIndicator').style.display = 'flex';
        document.getElementById('dmTargetName').innerText = targetName;
        document.getElementById('chatArea').innerHTML = ''; 
    }

    function exitDM() {
        activeDM = null;
        document.getElementById('dmIndicator').style.display = 'none';
        document.getElementById('chatArea').innerHTML = ''; 
    }

    function handleTyping() {
        socket.emit('typing', { roomID: activeDM ? activeDM.roomID : myCurrentRoom, name: document.getElementById('nameInput').value });
        clearTimeout(typingTimeout);
        typingTimeout = setTimeout(() => {
            socket.emit('stop-typing', { roomID: activeDM ? activeDM.roomID : myCurrentRoom });
        }, 2000);
    }

    function sendChat() {
        const input = document.getElementById('chatInput');
        const text = input.value.trim();
        const myName = document.getElementById('nameInput').value;
        if (!text) return;

        if (editingMsgID) {
            socket.emit('edit-message', { roomID: activeDM ? activeDM.roomID : myCurrentRoom, messageID: editingMsgID, newText: text });
            const msgEl = document.querySelector(`[data-msg-id="${editingMsgID}"]`);
            if (msgEl) {
                msgEl.querySelector('.msg-text').innerText = text;
                if (!msgEl.querySelector('.edited-indicator')) {
                    const span = document.createElement('span');
                    span.className = 'edited-indicator'; span.innerText = ' (edited)';
                    msgEl.querySelector('.msg-text').appendChild(span);
                }
            }
            cancelEdit();
        } else {
            const messageData = {
                id: 'msg-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9),
                roomID: activeDM ? activeDM.roomID : myCurrentRoom,
                sender: myName, senderUUID: myUUID, context: { text: text },
                color: myBrowserColor, serverTimestamp: Date.now(), isDM: !!activeDM
            };
            if (activeDM) {
                socket.emit('send-direct-message', { id: messageData.id, recipientUUID: activeDM.uuid, context: messageData.context, senderUUID: myUUID, fromName: myName });
            } else {
                socket.emit('send-message', { id: messageData.id, roomID: myCurrentRoom, context: messageData.context, senderUUID: myUUID, sender: myName });
            }
            displayMessage(messageData, true, !!activeDM);
        }
        input.value = '';
        socket.emit('stop-typing', { roomID: activeDM ? activeDM.roomID : myCurrentRoom });
    }

    function prepareEdit(msgID, currentText) {
        editingMsgID = msgID;
        document.getElementById('chatInput').value = currentText;
        document.getElementById('editModeBar').style.display = 'flex';
        document.getElementById('sendBtn').innerText = 'Save';
        document.getElementById('chatInput').focus();
    }

    function cancelEdit() {
        editingMsgID = null;
        document.getElementById('chatInput').value = '';
        document.getElementById('editModeBar').style.display = 'none';
        document.getElementById('sendBtn').innerText = 'Send';
    }

    function confirmDelete(msgID) {
        if (confirm("Delete this message?")) {
            socket.emit('delete-message', { roomID: activeDM ? activeDM.roomID : myCurrentRoom, messageID: msgID, userName: document.getElementById('nameInput').value });
            const msgEl = document.querySelector(`[data-msg-id="${msgID}"]`);
            if (msgEl) {
                msgEl.innerHTML = `<span class="deleted-msg">You deleted this message.</span>`;
                msgEl.style.opacity = "0.6";
            }
        }
    }

    function transferHost(targetId) { if(confirm("Promote user to host?")) socket.emit('transfer-host', { roomID: myCurrentRoom, newHostUUID: targetId }); }
    function removeUser(targetId) { if(confirm("Kick user?")) socket.emit('remove-user', { roomID: myCurrentRoom, userUUIDToRemove: targetId }); }

    function displayMessage(data, amISender, isDM) {
        const chatArea = document.getElementById('chatArea');
        if (data.id && document.querySelector(`[data-msg-id="${data.id}"]`)) return;
        const div = document.createElement('div');
        div.className = `msg ${amISender ? 'my-msg' : 'their-msg'} ${isDM ? 'dm-msg' : ''}`;
        if (data.id) div.setAttribute('data-msg-id', data.id);
        const text = data.context?.text || data.text || "...";
        div.innerHTML = `
            <span style="font-size: 10px; font-weight: bold; margin-bottom: 2px; opacity: 0.8;">${isDM ? 'üîí ' : ''}${amISender ? 'You' : data.sender}</span>
            <div class="msg-text">${text}</div>
            ${amISender ? `
                <div class="msg-actions">
                    <button class="btn-msg-action" onclick="prepareEdit('${data.id}', '${text.replace(/'/g, "\\'")}')">Edit</button>
                    <button class="btn-msg-action" onclick="confirmDelete('${data.id}')">Delete</button>
                </div>
            ` : ''}
        `;
        chatArea.appendChild(div);
        chatArea.scrollTop = chatArea.scrollHeight;
    }
</script>
</body>
</html>