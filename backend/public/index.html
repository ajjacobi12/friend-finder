<!DOCTYPE html>
<html>
<head>
    <title>Socket Test Dashboard</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 30px; background-color: #f4f4f9; display: flex; flex-direction: column; align-items: center; }
        .container { width: 100%; max-width: 550px; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .status { padding: 10px; margin-bottom: 20px; border-radius: 6px; text-align: center; font-weight: bold; }
        .online { background: #d4edda; color: #155724; }
        .offline { background: #f8d7da; color: #721c24; }
        .card { border-top: 2px solid #eee; padding-top: 15px; margin-top: 15px; }
        
        input { padding: 10px; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 10px; }
        .setup-input { width: 70%; }
        
        button { padding: 6px 10px; cursor: pointer; border: none; border-radius: 4px; font-weight: bold; transition: 0.2s; font-size: 12px; }
        .btn-create { background: #28a745; color: white; }
        .btn-join { background: #007bff; color: white; }
        .btn-leave { background: #dc3545; color: white; width: 100%; margin-top: 10px; padding: 10px; }
        .btn-send { background: #007bff; color: white; padding: 10px 20px; }
        
        /* Host control buttons */
        .btn-host-action { background: #6c757d; color: white; margin-left: 5px; }
        .btn-remove { background: #dc3545; color: white; margin-left: 5px; }
        
        ul { list-style: none; padding: 0; }
        li { padding: 10px; border-bottom: 1px solid #eee; display: flex; align-items: center; justify-content: space-between; }
        .user-info { display: flex; align-items: center; gap: 8px; }
        .host-crown { color: #f1c40f; font-size: 16px; }
        
        #chatArea { height: 250px; border: 1px solid #eee; border-radius: 8px; overflow-y: auto; padding: 15px; margin-bottom: 5px; background: #fafafa; display: flex; flex-direction: column; }
        .msg { margin-bottom: 10px; max-width: 85%; padding: 8px 12px; border-radius: 15px; font-size: 14px; line-height: 1.4; }
        .my-msg { align-self: flex-end; background: #007bff20; border-bottom-right-radius: 2px; border: 1px solid #007bff40; }
        .their-msg { align-self: flex-start; background: #e5e5ea; border-bottom-left-radius: 2px; }
        .msg-header { font-size: 11px; font-weight: bold; margin-bottom: 3px; display: block; }
        
        #typingDisplay { height: 20px; font-size: 12px; color: #888; font-style: italic; margin-bottom: 10px; padding-left: 5px; }
        .chat-input-container { display: flex; gap: 10px; }
        #chatInput { flex: 1; margin-bottom: 0; }
    </style>
</head>
<body>

<div class="container">
    <h2>ðŸ›  Room Control Center</h2>
    <div id="status" class="status offline">Connecting...</div>

    <div id="setupArea">
        <div class="card">
            <h3>Create Session</h3>
            <input type="text" id="createIdInput" class="setup-input" placeholder="Room ID (e.g. 9999)">
            <button class="btn-create" onclick="createSession()">Create</button>
        </div>

        <div id="joinArea" class="card">
            <h3>Join Session</h3>
            <input type="text" id="joinIdInput" class="setup-input" placeholder="Existing Room ID">
            <button class="btn-join" onclick="joinSession()">Join</button>
        </div>
    </div>

    <div id="roomArea" class="card" style="display:none;">
        <h3>Session: <span id="currentRoomDisplay"></span> <span id="iamHostTag" style="display:none; font-size: 12px; color: #f39c12;">(YOU ARE HOST)</span></h3>
        
        <div id="chatArea"></div>
        <div id="typingDisplay"></div>

        <div class="chat-input-container">
            <input type="text" id="chatInput" placeholder="Type a message..." oninput="emitTyping()" onkeypress="handleKeyPress(event)">
            <button class="btn-send" onclick="sendChat()">Send</button>
        </div>

        <p style="margin-top: 20px; font-weight: bold;">Active Users:</p>
        <ul id="userList"></ul>
        <button class="btn-leave" onclick="leaveSession()">ðŸšª Leave Session</button>
    </div>
</div>

<script>
    const socket = io();
    let myCurrentRoom = null;
    let myName = "Web Tester";
    let myColor = "#1e8fff";
    let amIHost = false;
    let typingUsers = new Map();
    let typingTimeout = null;
    let isTyping = false;

    socket.on('connect', () => {
        document.getElementById('status').innerText = "Connected: " + socket.id;
        document.getElementById('status').className = "status online";
    });

    socket.on('receive-message', (data) => {
        if (data.roomID === myCurrentRoom) displayMessage(data, false);
    });

    // --- HOST EVENTS ---
    socket.on('host-change', (newHostId) => {
        amIHost = (socket.id === newHostId);
        document.getElementById('iamHostTag').style.display = amIHost ? 'inline' : 'none';
        console.log("Host changed. Am I host?", amIHost);
    });

    socket.on('session-ended', () => {
        alert("The host has ended the session.");
        location.reload();
    });

    socket.on('removed-from-session', () => {
        alert("You have been removed by the host.");
        location.reload();
    });

    // --- USER UPDATES & RENDERING ---
    socket.on('user-update', (users) => {
        const userListUl = document.getElementById('userList');
        userListUl.innerHTML = '';

        // Check if I am still the host from the list (backup check)
        const me = users.find(u => u.id === socket.id);
        if (me) {
            amIHost = me.isHost;
            document.getElementById('iamHostTag').style.display = amIHost ? 'inline' : 'none';
        }

        users.forEach(user => {
            const li = document.createElement('li');
            
            // Name and Crown
            let userDisplay = `<div class="user-info">
                <span>${user.isHost ? '<span class="host-crown">ðŸ‘‘</span>' : ''} <strong>${user.name}</strong></span>
                ${user.id === socket.id ? '<i>(You)</i>' : ''}
            </div>`;

            // Host Actions (Only show buttons if I am host AND this user isn't me)
            let actions = `<div>`;
            if (amIHost && user.id !== socket.id) {
                actions += `
                    <button class="btn-host-action" onclick="transferHost('${user.id}')">Make Host</button>
                    <button class="btn-remove" onclick="removeUser('${user.id}')">Kick</button>
                `;
            }
            actions += `</div>`;

            li.innerHTML = userDisplay + actions;
            userListUl.appendChild(li);
        });
    });

    // --- ACTIONS ---
    function transferHost(newHostId) {
        if (confirm("Transfer host status to this user?")) {
            socket.emit('transfer-host', { roomID: myCurrentRoom, newHostId });
        }
    }

    function removeUser(userIdToRemove) {
        if (confirm("Are you sure you want to kick this user?")) {
            socket.emit('remove-user', { roomID: myCurrentRoom, userIdToRemove });
        }
    }

    function createSession() {
        const roomID = document.getElementById('createIdInput').value.toUpperCase();
        if (!roomID) return;
        socket.emit('create-session', roomID, () => {
            setupInRoom(roomID);
        });
    }

    function joinSession() {
        const roomID = document.getElementById('joinIdInput').value.toUpperCase();
        if (!roomID) return;
        socket.emit('join-session', roomID, (res) => {
            if (res.exists) setupInRoom(roomID);
            else alert("Room doesn't exist");
        });
    }

    function setupInRoom(roomID) {
        myCurrentRoom = roomID;
        document.getElementById('currentRoomDisplay').innerText = roomID;
        document.getElementById('roomArea').style.display = 'block';
        document.getElementById('setupArea').style.display = 'none';
        socket.emit('update-user', { name: myName, color: myColor, sessionId: roomID });
    }

    // --- MESSAGING ---
    function sendChat() {
        const input = document.getElementById('chatInput');
        const text = input.value.trim();
        if (text.length > 0 && myCurrentRoom) {
            const messageData = {
                roomID: myCurrentRoom,
                sender: myName,
                context: { text: text },
                color: myColor,
                time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
                id: socket.id 
            };
            socket.emit('send-message', messageData);
            displayMessage(messageData, true);
            input.value = '';
        }
    }

    function displayMessage(data, isMe) {
        const chatArea = document.getElementById('chatArea');
        const msgDiv = document.createElement('div');
        msgDiv.className = `msg ${isMe ? 'my-msg' : 'their-msg'}`;
        const messageText = data.context ? data.context.text : (data.text || "");
        msgDiv.innerHTML = `<span class="msg-header" style="color: ${data.color}">${data.sender}</span><div>${messageText}</div>`;
        chatArea.appendChild(msgDiv);
        chatArea.scrollTop = chatArea.scrollHeight;
    }

    function emitTyping() {
        if (!isTyping) {
            isTyping = true;
            socket.emit('typing', { roomID: myCurrentRoom, name: myName });
        }
        if (typingTimeout) clearTimeout(typingTimeout);
        typingTimeout = setTimeout(() => {
            socket.emit('stop-typing', { roomID: myCurrentRoom });
            isTyping = false;
        }, 2000);
    }

    function handleKeyPress(e) { if (e.key === 'Enter') sendChat(); }
    function leaveSession() { location.reload(); }

    socket.on('user-typing', (data) => { typingUsers.set(data.id, data.name); renderTyping(); });
    socket.on('user-stop-typing', (data) => { typingUsers.delete(data.id); renderTyping(); });
    function renderTyping() {
        const display = document.getElementById('typingDisplay');
        const names = Array.from(typingUsers.values());
        display.innerText = names.length > 0 ? (names.length === 1 ? `${names[0]} is typing...` : "Multiple people typing...") : "";
    }
</script>
</body>
</html>